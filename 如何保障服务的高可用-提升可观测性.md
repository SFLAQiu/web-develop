# ä¸€ ã€ç®€ä»‹

![](https://sflaqiu.github.io/imgs/388a59d45e464130a2bb1e3cb53f2c54~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png)

ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ï¼Œå¿…ä¸å¯å°‘çš„æªæ–½ï¼Œå°±æ˜¯éœ€è¦å¯¹æœåŠ¡èµ„æºä½¿ç”¨åº¦é‡æƒ…å†µã€è¿è¡Œå¼‚å¸¸ã€é€»è¾‘é”™è¯¯ã€è¯·æ±‚é“¾è·¯ã€ç­‰å„é¡¹åº¦é‡æŒ‡æ ‡ã€æ—¥å¿—å’Œé“¾è·¯äº†å¦‚æŒ‡æŒï¼Œå¹¶ä¸”é€šè¿‡å¯¹æœåŠ¡çš„å®æ—¶ç›‘æ§å’Œåˆ†æï¼Œé…ç½®æŒ‡æ ‡é¢„è­¦å€¼ï¼Œå¯¹å¼‚å¸¸è¿›è¡Œå‘Šè­¦ï¼Œé€šçŸ¥åˆ°ç›¸å…³è´Ÿè´£äººï¼Œé€šè¿‡å¯è§‚æµ‹æ€§çš„æå‡ï¼Œé¢„é˜²å’ŒåŠæ—¶å‘ç°é—®é¢˜ï¼Œä¿éšœæœåŠ¡çš„å¯ç”¨æ€§ã€‚

åœ¨å¯è§‚æµ‹æ€§çš„å†…å®¹ä¸­ï¼Œå¯ä»¥æŠ½è±¡å‡ºä¸‰å¤§å…ƒç´ ï¼š**æ—¥å¿—ï¼ˆLogsï¼‰** ã€**è·Ÿè¸ªï¼ˆTracesï¼‰** ã€**æŒ‡æ ‡ï¼ˆMetricsï¼‰** ï¼Œè¿™ä¸‰å¤§å…ƒç´ å°±æ˜¯å¯è§‚æµ‹æ€§çš„ä¸‰å¤§æ”¯æŸ±ã€‚

![image.png](https://sflaqiu.github.io/imgs/05505cd934554b5ea1b482e73b1faf3d~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=300&h=275&s=36391&e=png&b=fffefe)

æ—¥å¿—æ”¶é›†ã€é“¾è·¯è¿½è¸ªå’Œåº¦é‡æŒ‡æ ‡éƒ½æ˜¯**é¥æµ‹**ä½“ç³»çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä»¬ä¸€èµ·æ„æˆäº†è§‚æµ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½çš„å…³é”®æ•°æ®åŸºç¡€ã€‚

ä¸‹é¢æ¢³ç†åœ¨ä»ä¸šè¿‡ç¨‹ä¸­å¯¹äºå¯è§‚æµ‹æ€§çš„ç›¸å…³æ¶æ„å’Œå¼€æºå·¥å…·çš„å®ç°åŸç†çš„ç†è§£ï¼Œè¿™é‡Œç‚¹åˆ°ä¸ºæ­¢ï¼Œä¸»è¦è®©å¤§å®¶äº†è§£æœ‰å“ªäº›æŠ€æœ¯ç‚¹ï¼Œæƒ³è¦äº†è§£æ›´å…·ä½“çš„å†…å®¹ï¼Œå¯ä»¥åˆ°æœç´¢ä¸­æŸ¥è¯¢ï¼Œæœ‰å¾ˆå¤šå¥½çš„è¯¦ç»†çš„æ–‡ç« ã€‚

# äºŒã€**æ—¥å¿—ï¼ˆLogsï¼‰**

è®°å½•å¹¶**æ±‡é›†**ç³»ç»Ÿè¿è¡Œæ—¶äº§ç”Ÿçš„**æ—¥å¿—**ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº**é”™è¯¯ä¿¡æ¯**ã€**è­¦å‘Š**ã€**è°ƒè¯•ä¿¡æ¯**ä»¥åŠ**åº”ç”¨è¡Œä¸ºç»†èŠ‚**ï¼Œè¿™äº›ä¿¡æ¯æœ‰åŠ©äºè¿›è¡Œ**é—®é¢˜æ’æŸ¥**ã€**æ€§èƒ½åˆ†æ**å’Œ**ç³»ç»Ÿå®¡è®¡**ã€‚

## 2.1 æ—¥å¿—åº”ç”¨

- nginx-errï¼š**nginx-log** + **logstash** + **es** + **kibana**
- go-errorï¼š**log-center** + **kafka** + **logstash** + **es** +**kibana**

å…¶ä¸­ç”¨åˆ°çš„å·¥å…·ï¼š

**ELK**  
**Elasticsearchï¼š** åˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“ï¼ˆå­˜å‚¨æ—¥å¿—æ•°æ®ï¼‰ã€‚  
**Logstashï¼š** æ•°æ®æ”¶é›†ã€è¿‡æ»¤ä¸è½¬å‘å·¥å…·ï¼ˆElastic Stack ä¸€éƒ¨åˆ†ï¼‰ã€‚  
**Kibanaï¼š** æ•°æ®å¯è§†åŒ–å¹³å°ï¼ˆElastic Stack ä¸€éƒ¨åˆ†ï¼‰  
**log-centerï¼š** è‡ªç ” UDP æ—¥å¿—æœåŠ¡

## 2.2 æ—¥å¿—æ¶æ„

### 2.2.1 **UDP** **æ—¥å¿—æœåŠ¡æ—¥å¿—æ”¶é›†æ¶æ„**

![screenshot-20240220-212233.png](https://sflaqiu.github.io/imgs/656fde91db3d41c2bc8b190f234fb08f~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=250&h=402&s=79309&e=png&b=fcfbfb)

Log-center æ˜¯è‡ªç ”çš„ upd æ—¥å¿—æœåŠ¡ï¼Œåº”ç”¨æœåŠ¡å°†æ—¥å¿—ä¸ŠæŠ¥åˆ°æ—¥å¿—æœåŠ¡ï¼Œæ—¥å¿—æœåŠ¡å°†æ—¥å¿—å†™å…¥åˆ° kafkaï¼Œç„¶åå†é€šè¿‡ logstash ä» kafka åŒæ­¥åˆ° ESï¼Œç ”å‘äººå‘˜é€šè¿‡ kibana æŸ¥è¯¢ ES æ—¥å¿—ã€‚

kibana åŠŸèƒ½è¿˜æ˜¯å¾ˆå¼ºå¤§ï¼Œé™¤äº†æ—¥å¿—æŸ¥è¯¢ï¼Œè¿˜æ”¯æŒ Visualize ç»Ÿè®¡å›¾è¡¨ï¼ŒDashboards ä»ªè¡¨æ¿ æ·»åŠ  Panels ç­‰ç­‰ï¼Œå…·ä½“å¯ä»¥æœç´¢äº†è§£ç›¸å…³ä»‹ç»ã€‚

### 2.2.2 N**ginx** **æ—¥å¿—æ–‡ä»¶** **æ”¶é›†æ¶æ„**

![](https://sflaqiu.github.io/imgs/e270e42f73824c47b4ca70cb4d1d24c0~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=257&h=300&s=26088&e=png&b=fefefe)

é€šè¿‡ logstash å°† nginx æ—¥å¿—é‡‡é›†ä¸ŠæŠ¥åˆ° ESï¼Œå…¶ä»–å’Œä¸Šé¢ä¸€æ ·ã€‚

# ä¸‰ã€è·Ÿè¸ªï¼ˆTracesï¼‰

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå°¤å…¶æ˜¯å¾®æœéƒ¨ç½²ï¼ŒæœåŠ¡ä¹‹é—´çš„é“¾è·¯è°ƒç”¨é”™ç»¼å¤æ‚ã€‚é“¾è·¯è¿½è¸ªç”¨äºè¿½è¸ªä¸€ä¸ªè¯·æ±‚åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ä¼ é€’è¿‡ç¨‹ï¼Œè®°å½•æ¯ä¸ªæœåŠ¡è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚è°ƒç”¨é¡ºåºã€è€—æ—¶ã€çŠ¶æ€ç­‰ï¼Œè¿™å¯¹äºè§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤æ‚é—®é¢˜å’Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è‡³å…³é‡è¦ã€‚

## 3.1 **é“¾è·¯è¿½è¸ªåº”ç”¨**

- php **apm**
- go **jeager** trace
- **kiali** istio mesh

å…¶ä¸­ç”¨åˆ°çš„å·¥å…·ï¼š

**Jaegerï¼š** åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œç”¨äºå¾®æœåŠ¡å’Œäº‘åŸç”Ÿåº”ç”¨çš„æ€§èƒ½ç›‘æ§ä¸æ•…éšœæ’æŸ¥ã€‚  
**Kialiï¼š** æœåŠ¡ç½‘æ ¼å¯è§†åŒ–ä¸ç®¡ç†å·¥å…·ï¼ˆIstioï¼‰ã€‚

## 3.2 å…³äº **jeager**

jeager åˆ†å¸ƒå¼è¿½è¸ªï¼Œé“¾è·¯ç»„æˆï¼š**Span**ï¼Œ**Trace**ã€‚

ä¸€ä¸ª Span è¡¨ç¤º Jaeger çš„**é€»è¾‘å·¥ä½œå•å…ƒ**ï¼ŒSpan å…·æœ‰**æ“ä½œåç§°ï¼Œæ“ä½œçš„å¼€å§‹æ—¶é—´ï¼Œå’ŒæŒç»­æ—¶é—´**ã€‚Span å¯ä»¥åµŒå¥—å¹¶æ’åºä»¥å»ºç«‹å› æœå…³ç³»æ¨¡å‹ã€‚

ä¸€ä¸ª Trace æ˜¯é€šè¿‡ç³»ç»Ÿçš„æ•°æ®/æ‰§è¡Œè·¯å¾„ï¼ŒTrace å¯è¢«è®¤ä¸ºæ˜¯ç”±**ä¸€ç»„ Span å®šä¹‰çš„æœ‰å‘æ— ç¯å›¾**ã€‚

### 3.2.1 jeager **é“¾è·¯é€»è¾‘å›¾**

![](https://sflaqiu.github.io/imgs/b8c36693272d40e6ad6fdd937c32c8f8~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=960&h=540&s=38959&e=png&b=fefefe)

### 3.2.2 **jeager æ¶æ„å›¾**

æ”¶é›†å™¨ç›´æ¥**å†™å…¥å­˜å‚¨**

![](https://sflaqiu.github.io/imgs/88479f10152f49ec9888f62cc8bb1861~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=960&h=540&s=80644&e=png&b=fefdfd)

æ”¶é›†å™¨**å†™å…¥** **Kafka** ä½œä¸ºä¸­é—´ç¼“å†²

![](https://sflaqiu.github.io/imgs/660c56cf345d4c86bc54706fa0ef7bdd~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=960&h=540&s=83055&e=png&b=fefdfd)

### 3.2.3 **jeager ç»„ä»¶è¯´æ˜**

- **Jaeger Client** ä¸ºä¸åŒè¯­è¨€å®ç°äº†ç¬¦åˆ OpenTracing æ ‡å‡†çš„ SDKã€‚åº”ç”¨ç¨‹åºé€šè¿‡ API å†™å…¥æ•°æ®ï¼Œclient library æŠŠ trace ä¿¡æ¯æŒ‰ç…§åº”ç”¨ç¨‹åºæŒ‡å®šçš„é‡‡æ ·ç­–ç•¥ä¼ é€’ç»™ jaeger-agentã€‚
- **Agent** å®ƒæ˜¯ä¸€ä¸ªç›‘å¬åœ¨ UDP ç«¯å£ä¸Šæ¥æ”¶ span æ•°æ®çš„ç½‘ç»œå®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒä¼šå°†æ•°æ®æ‰¹é‡å‘é€ç»™ collectorã€‚å®ƒè¢«è®¾è®¡æˆä¸€ä¸ªåŸºç¡€ç»„ä»¶ï¼Œéƒ¨ç½²åˆ°æ‰€æœ‰çš„å®¿ä¸»æœºä¸Šã€‚Agent å°† client library å’Œ collector è§£è€¦ï¼Œä¸º client library å±è”½äº†è·¯ç”±å’Œå‘ç° collector çš„ç»†èŠ‚ã€‚
- **Collector** æ¥æ”¶ jaeger-agent å‘é€æ¥çš„æ•°æ®ï¼Œç„¶åå°†æ•°æ®å†™å…¥åç«¯å­˜å‚¨ã€‚Collector è¢«è®¾è®¡æˆæ— çŠ¶æ€çš„ç»„ä»¶ï¼Œå› æ­¤æ‚¨å¯ä»¥åŒæ—¶è¿è¡Œä»»æ„æ•°é‡çš„ jaeger-collectorã€‚
- **Data Store** åç«¯å­˜å‚¨è¢«è®¾è®¡æˆä¸€ä¸ªå¯æ’æ‹”çš„ç»„ä»¶ï¼Œæ”¯æŒå°†æ•°æ®å†™å…¥ cassandraã€elastic searchã€‚
- **Query** æ¥æ”¶æŸ¥è¯¢è¯·æ±‚ï¼Œç„¶åä»åç«¯å­˜å‚¨ç³»ç»Ÿä¸­æ£€ç´¢ trace å¹¶é€šè¿‡ UI è¿›è¡Œå±•ç¤ºã€‚

### 3.2.4 **jeager ä»£ç å…¥ä¾µ**

å°†å¾®æœåŠ¡ä¸­çš„ gRPC å’Œ HTTP ä»£ç ä¸­åµŒå…¥è¿½è¸ªç›¸å…³çš„ä»£ç 

- åœ¨ HTTP æœåŠ¡ä¸­é›†æˆ Jaegerï¼Œæ—©æœŸçš„åšæ³•å¯èƒ½éœ€è¦åœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†å™¨ä¸­æ˜¾å¼åˆ›å»ºä¸€ä¸ªæ–°çš„ Spanï¼Œå¹¶è®¾ç½®çˆ¶ Spanï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚ä¾‹å¦‚ï¼Œåœ¨ Node.js ä¸­ï¼Œä½¿ç”¨ `opentracing` åº“å’Œ `jaeger-client` æ—¶ï¼Œéœ€è¦åœ¨ä¸­é—´ä»¶ä¸­æ³¨å…¥è¿½è¸ªé€»è¾‘ï¼Œåˆå§‹åŒ– Span å¹¶å°†å…¶ç»‘å®šåˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ã€‚
- åœ¨ gRPC æœåŠ¡ä¸­ï¼ŒåŒæ ·éœ€è¦åœ¨æ¯ä¸ªæœåŠ¡æ–¹æ³•çš„å‰ååˆ›å»º Spanï¼Œé€šå¸¸ä¹Ÿéœ€è¦è®¾ç½®ç›¸åº”çš„çˆ¶ Spanã€‚gRPC ç¤¾åŒºä¸ºæ­¤æä¾›äº†æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰æœºåˆ¶ï¼Œå¯ä»¥é¿å…ç›´æ¥åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ·»åŠ è¿½è¸ªä»£ç ã€‚é€šè¿‡ç¼–å†™ä¸€ä¸ª gRPC æ‹¦æˆªå™¨ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡é€»è¾‘ä»£ç çš„æƒ…å†µä¸‹æ³¨å…¥ Jaeger çš„è¿½è¸ªè¡Œä¸ºã€‚

å­˜å‚¨ mysql ï¼Œä¸­é—´ä»¶ redisã€kafka ï¼Œç›¸å…³çš„ client åŒ…ä¹Ÿéƒ½æ”¯æŒæ·»åŠ è¿½è¸ªçš„ç›¸å…³æ‹¦æˆªçš„ä»£ç ã€‚

è¿™æ ·æ•´ä¸ªé“¾è·¯è¿½è¸ªå°±å¯ä»¥è´¯ç©¿åº”ç”¨çš„å„ä¸ªå…³ç³»å±‚çº§ï¼Œåœ¨ jeager ui ä¸­å°±å¯ä»¥çœ‹åˆ°ä»è¯·æ±‚å‘èµ·åˆ°æœåŠ¡è°ƒç”¨ï¼Œä»¥åŠå­˜å‚¨æ“ä½œï¼Œä¸­é—´ä»¶æ“ä½œçš„æ•´ä¸ªé“¾è·¯çš„è°ƒç”¨å…³ç³»ã€‚

# å››ã€æŒ‡æ ‡ï¼ˆMetricsï¼‰

åº¦é‡æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶ç»Ÿè®¡çš„å„ç§é‡åŒ–æ•°æ®ï¼Œå¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€ç½‘ç»œå¸¦å®½ã€è¯·æ±‚å¤„ç†é€Ÿç‡ã€é”™è¯¯ç‡ç­‰ï¼Œè¿™äº›æ•°æ®å¯ç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ã€é¢„æµ‹æ½œåœ¨é—®é¢˜ã€åˆ¶å®šå®¹é‡è§„åˆ’ã€æŒæ¡æœåŠ¡æ°´å¹³ã€‚

## 4.1 **åº¦é‡æŒ‡æ ‡åº”ç”¨**

- k8sï¼š**k8s-ServiceMonitor** + **promethus** + **grafana**
- Kafkaï¼š**kafka-exporter** + **promethus** + **grafana**
- escï¼š **ecs-exporter** + **promethus** + **grafana**
- mysqlï¼š**mysql-exporter** + **promethus** + **grafana**
- redisï¼š**redis-exporter** + **promethus** + **grafana**
- ...

å…¶ä¸­ç”¨åˆ°çš„å·¥å…·ï¼š

**Grafana**ï¼šå¤šæ•°æ®æºçš„ç›‘æ§ä»ªè¡¨æ¿ä¸åˆ†æå·¥å…·ã€‚  
**Prometheusï¼š** ç›‘æ§ä¸è­¦æŠ¥å·¥å…·ï¼Œä¸»è¦ç”¨äºåº¦é‡æ”¶é›†ä¸åˆ†æ

## 4.2 å…³äº **Prometheus**

å®ƒé’ˆå¯¹å¤§è§„æ¨¡çš„é›†ç¾¤ç¯å¢ƒè®¾è®¡äº†æ‹‰å–å¼çš„æ•°æ®é‡‡é›†æ–¹å¼ï¼Œä½ åªéœ€è¦åœ¨ä½ çš„åº”ç”¨é‡Œé¢å®ç°ä¸€ä¸ª`metrics`æ¥å£ï¼Œç„¶åæŠŠè¿™ä¸ªæ¥å£å‘Šè¯‰`Prometheus`å°±å¯ä»¥å®Œæˆæ•°æ®é‡‡é›†äº†ã€‚è€Œä¸”è¿˜å†…ç½®äº†æŠ¥è­¦åŠŸèƒ½ã€‚

### 4.2.1 **Prometheus çš„æ•´ä½“æ¶æ„**

![](https://sflaqiu.github.io/imgs/d0d387924f694e84bd0131caa21173b9~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=1584&h=954&s=755921&e=png&b=fdfbfb)

### 4.2.2 **Prometheus ç»„ä»¶ç®€è¦**

- **Prometheus Serverï¼š** å­˜å‚¨å’Œæ£€ç´¢æ—¶åºæ•°æ®çš„æ ¸å¿ƒï¼Œå®šæœŸä»é…ç½®çš„ç›‘æ§ç›®æ ‡æ‹‰å–æŒ‡æ ‡ã€‚
- **Exporterï¼š** å„ç§ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè´Ÿè´£å°†ä¸åŒæœåŠ¡å’Œç³»ç»Ÿçš„åº¦é‡æ•°æ®æš´éœ²ç»™ Prometheusï¼Œè½¬æ¢æˆ Prometheus å¯è¯»æ ¼å¼ã€‚
- **Pushgatewayï¼ˆå¯é€‰ï¼‰ï¼š** ä¸­é—´ä»£ç†ï¼Œå…è®¸çŸ­æœŸä»»åŠ¡æˆ–å…¶ä»–éé•¿é©»æœåŠ¡å°†æŒ‡æ ‡æ¨é€åˆ° Prometheusï¼Œå› ä¸º Prometheus é€šå¸¸é‡‡ç”¨çš„æ˜¯ Pull æ¨¡å‹ã€‚
- **PromQLï¼š** ä¸“ä¸º Prometheus è®¾è®¡çš„æ—¶é—´åºåˆ—æŸ¥è¯¢è¯­è¨€ï¼Œç”¨äºåˆ†æå’Œèšåˆç›‘æ§æ•°æ®ã€‚
- **Alertmanagerï¼š** è­¦æŠ¥å¤„ç†ç»„ä»¶ï¼Œå¯¹ Prometheus äº§ç”Ÿçš„è­¦æŠ¥è¿›è¡Œç®¡ç†å’Œé€šçŸ¥ï¼ŒåŒ…æ‹¬é™é»˜ã€åˆ†ç»„åŠè·¯ç”±è‡³é€‚å½“çš„æ¥æ”¶è€…ã€‚
- **Web UI** **ï¼š** å†…ç½®å›¾å½¢ç•Œé¢ï¼Œç”¨äºæŸ¥è¯¢ã€å¯è§†åŒ–å’Œæµè§ˆ Prometheus æ•°æ®ä»¥åŠæŸ¥çœ‹æŠ¥è­¦çŠ¶æ€ã€‚
- **Client Librariesï¼š** æä¾›ç»™åº”ç”¨å¼€å‘è€…ç›´æ¥åœ¨ä»£ç ä¸­é›†æˆ Prometheus ç›‘æ§çš„åº“ï¼Œä»¥ä¾¿æ›´æ–¹ä¾¿åœ°æš´éœ²åº”ç”¨å†…éƒ¨çš„åº¦é‡æŒ‡æ ‡ã€‚

ä»¥ä¸Šå„ç»„ä»¶å…±åŒæ„æˆäº†å®Œæ•´çš„ Prometheus ç›‘æ§ä½“ç³»ç»“æ„ï¼Œèƒ½å¤Ÿå®ç°é«˜æ•ˆåœ°æ•°æ®é‡‡é›†ã€å­˜å‚¨ã€åˆ†æå’ŒæŠ¥è­¦åŠŸèƒ½ã€‚

### 4.2.3 **Prometheus ä¸­å››ç§åº¦é‡**

- **Counterï¼š** è®¡æ•°å™¨ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºåªå¢ä¸å‡çš„ç´¯è®¡å€¼ï¼Œå¦‚è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ¬¡æ•°ç­‰ã€‚å³ä½¿æœåŠ¡é‡å¯ï¼Œè®¡æ•°å™¨ä¹Ÿä¼šåœ¨ä¸‹æ¬¡æ”¶é›†æ—¶ä¿ç•™ä¸Šæ¬¡çš„å€¼ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯ä¸èƒ½å‡å°‘ï¼Œåªèƒ½å¢åŠ æˆ–é‡ç½®ä¸ºé›¶ã€‚
- **Gaugeï¼š** è¡¨ç›˜ç±»å‹ï¼Œè¡¨ç¤ºä»»æ„æ—¶åˆ»å¯å¢å¯å‡çš„ç¬æ—¶å€¼ï¼Œå¦‚å†…å­˜ä½¿ç”¨é‡ã€åœ¨çº¿ç”¨æˆ·æ•°ã€è¯·æ±‚å¤„ç†é€Ÿç‡ç­‰ã€‚Gauge å¯ä»¥ä¸Šå‡ã€ä¸‹é™æˆ–ä¿æŒä¸å˜ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºä»»æ„å˜é‡çš„çŠ¶æ€ã€‚
- **Histogram** **ï¼š** ç›´æ–¹å›¾ç±»å‹ï¼Œç”¨äºæµ‹é‡è§‚æµ‹å€¼çš„åˆ†å¸ƒæƒ…å†µï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´ã€‚å®ƒå¯ä»¥è‡ªåŠ¨å¯¹è§‚æµ‹å€¼è¿›è¡Œæ¡¶åˆ’åˆ†ï¼Œæä¾›è§‚æµ‹å€¼è½åœ¨å„ä¸ªæ¡¶å†…çš„æ•°é‡ä»¥åŠæ€»å’Œã€å¹³å‡å€¼ç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚
- **Summaryï¼š** æ¦‚è¦ç»Ÿè®¡ç±»å‹ï¼Œä¹Ÿç”¨äºè¡¡é‡è§‚æµ‹å€¼çš„åˆ†å¸ƒï¼Œä½†å®ƒå…è®¸è‡ªå®šä¹‰è®¡ç®—ç™¾åˆ†ä½æ•°ï¼ˆå¦‚ p50, p90, p99ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥æä¾›è§‚æµ‹å€¼çš„æ€»æ¬¡æ•°ã€æ€»å’Œä»¥åŠè‡ªå®šä¹‰çš„ç™¾åˆ†ä½æ•°æ•°æ®ã€‚ä¸ Histogram ç±»ä¼¼ï¼Œä½†æä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œè®¡ç®—ç²¾åº¦ã€‚

### 4.2.4 **Prometheus åº”ç”¨**

**ä¸šåŠ¡æŒ‡æ ‡ï¼š** å°†ä¸šåŠ¡ä¸­çš„ä¸€äº›æ ¸å¿ƒæŒ‡æ ‡ã€é˜Ÿåˆ—é•¿åº¦ã€å¼‚å¸¸æƒ…å†µã€ç­‰ä¸šåŠ¡åº¦é‡è¾“å‡ºï¼Œç„¶åé€šè¿‡ grafana é…ç½®é¢æ¿è¿›è¡Œå±•ç¤ºå’Œé¢„è­¦ï¼Œ grafana çš„ä½¿ç”¨å…·ä½“åé¢ä¼šä»‹ç»åˆ°ã€‚

ä¸šåŠ¡åº”ç”¨æœåŠ¡çš„æŒ‡æ ‡ä¸ŠæŠ¥ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨ pull metric çš„æ–¹å¼ï¼Œé€šè¿‡åº”ç”¨æœåŠ¡é¡¹ç›®ä»£ç æ¥å…¥ prometheus client ï¼Œåº”ç”¨æœåŠ¡å¯åŠ¨åä¼šåŒæ—¶èµ·ä¸€ä¸ªç”¨äºæ‹‰å–æŒ‡æ ‡çš„ http æœåŠ¡ï¼Œç„¶ååœ¨å†…ç½‘ä¸­æš´éœ²è®¿é—®ç«¯å£ï¼Œprometheus config æ¥é…ç½®æŠ“å–åº”ç”¨æš´éœ²çš„æŒ‡æ ‡ç«¯ç‚¹ã€‚

**èµ„æºç›‘æ§ï¼š** é€šè¿‡ exporter å°†æœåŠ¡æ¶æ„ä¸­ä½¿ç”¨åˆ°çš„ esc ã€k8s node pod container ã€mysql ã€redis ã€kafka ç­‰ï¼ŒæœåŠ¡å™¨èµ„æºï¼Œæ ¸å¿ƒåŠŸèƒ½æŒ‡æ ‡è¿›è¡Œä¸ŠæŠ¥ï¼ŒåŒæ ·ä½¿ç”¨ grafana å±•ç¤ºå’Œé¢„è­¦ã€‚

## 4.3 å…³äº Grafana

Grafana æ˜¯ä¸€ä¸ªç›‘æ§ä»ªè¡¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥å¤§å¤§å¸®åŠ©æˆ‘ä»¬ç®€åŒ–ç›‘æ§çš„å¤æ‚åº¦ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›éœ€è¦ç›‘æ§çš„æ•°æ®ï¼Œå®ƒå°±å¯ä»¥å¸®åŠ©ç”Ÿæˆå„ç§å¯è§†åŒ–ä»ªè¡¨ï¼ŒåŒæ—¶å®ƒè¿˜æœ‰æŠ¥è­¦åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶å‘å‡ºé€šçŸ¥ã€‚

Grafana æ”¯æŒè®¸å¤šä¸åŒçš„æ•°æ®æºï¼Œæ¯ä¸ªæ•°æ®æºéƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„æŸ¥è¯¢ç¼–è¾‘å™¨ï¼Œæ¯ä¸ªæ•°æ®æºçš„æŸ¥è¯¢è¯­è¨€å’Œèƒ½åŠ›éƒ½æ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¥è‡ªå¤šä¸ªæ•°æ®æºçš„æ•°æ®ç»„åˆåˆ°ä¸€ä¸ªä»ªè¡¨æ¿ï¼Œä½†æ¯ä¸€ä¸ªé¢æ¿è¢«ç»‘å®šåˆ°ä¸€ä¸ªç‰¹å®šçš„æ•°æ®æºã€‚

å…·ä½“çš„ Web UI çš„ä½¿ç”¨ AlertManager å‘Šè­¦çš„é…ç½®ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»ï¼Œæƒ³è¦äº†è§£çš„å¯ä»¥æœç´¢ï¼Œæ€»ç»“å°±æ˜¯å¾ˆå¼ºå¤§ã€‚

![](https://sflaqiu.github.io/imgs/7257e0b34efe46509cf4f62a91805907~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=1040&h=580&s=210046&e=png&b=181b1f)

### 4.3.1 **Grafana åº”ç”¨**

æˆ‘ä»¬å°†æ—¥å¿— ESã€æŒ‡æ ‡çš„ Promethues åŠ å…¥åˆ° grafana æ•°æ®æºï¼Œç„¶åå¢åŠ  panel å¯è§†åŒ–å›¾è¡¨ï¼Œé€šè¿‡ AlertManager è®¾ç½®é¢„è­¦å€¼ï¼Œé€šè¿‡é’‰é’‰ç¾¤é€šçŸ¥è¿›è¡Œå‘Šè­¦é€šçŸ¥ï¼Œæ•´ä½“æ­é…èµ·æ¥ä½¿ç”¨æ˜¯çœŸçš„é¦™ã€‚

**ES æ—¥å¿—**ï¼šå¯ä»¥å¯¹æ—¥å¿—è¿›è¡ŒæŸ¥è¯¢å¯è§†åŒ–å±•ç¤ºå’Œç›‘æ§ï¼Œæ¯”å¦‚ï¼šè¯·æ±‚ qpsã€å¼‚å¸¸ 5xx æ•°é‡ã€ ç¨‹åº error æ•°é‡ã€ msyql æ…¢æ—¥å¿—ã€ç­‰è¯·æ±‚å’Œç¨‹åºå¼‚å¸¸æƒ…å†µçš„é¢„è­¦ã€‚

**Promethues åº¦é‡ï¼š** å¯¹ä¸ŠæŠ¥çš„ä¸šåŠ¡æŒ‡æ ‡åº¦é‡è¿›è¡Œç›‘æ§å’Œå¼‚å¸¸å‘Šè­¦ï¼Œå¦‚ï¼šé˜Ÿåˆ—æ¶ˆè´¹å¼‚å¸¸ã€æ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸ã€æœåŠ¡èµ„æºã€ç­‰ã€‚

# äº”ã€æœªæ¥å±•æœ›

![](https://sflaqiu.github.io/imgs/a62a0cec9794462980d323794d9242e3~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75.png#?w=1572&h=868&s=1404356&e=png&b=822b0b)

å½“å‰æ¥å…¥å¤šä¸ªå¯è§‚æµ‹æ€§çš„å·¥å…·ç³»ç»Ÿï¼Œå„ç³»ç»Ÿè‡ªç›¸å¯¹ç‹¬ç«‹ï¼Œæ’æŸ¥é—®é¢˜åªèƒ½é€šè¿‡å”¯ä¸€æ ‡è¯† uid ç­‰ä¿¡æ¯ï¼Œé€šè¿‡äººå·¥çš„ä¸²è”ä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨å¤šä¸ªç³»ç»Ÿä¸­è¿›è¡Œè§‚æµ‹ä¿¡æ¯çš„ä¸²è”ï¼Œé‚£å°±å¯ä»¥å‡å»äººå·¥åŒ¹é…çš„è¿‡ç¨‹ï¼Œè¾¾åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœã€‚å¦‚ï¼šç”¨æˆ·åé¦ˆé—®é¢˜æˆ–è€…å¼‚å¸¸å‘Šè­¦ï¼Œé€šè¿‡ä»è¯·æ±‚å¼‚å¸¸/è¯·æ±‚æ—¥å¿—ä¸­è·å¾—é“¾è·¯çš„ trace-idï¼Œç„¶ååœ¨é“¾è·¯è¿½è¸ªä¸­æŸ¥çœ‹ç”¨æˆ·å½“å‰è¿™ä¸ªè¯·æ±‚çš„é“¾è·¯æƒ…å†µï¼Œä»¥åŠå¯ä»¥æŸ¥è¯¢å½“å‰è¯·æ±‚æ‰€åœ¨æ—¶åˆ»çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€ podã€container èµ„æºæƒ…å†µï¼Œä¸²è”åå¯ä»¥æå‡äººå‘˜å¯¹é—®é¢˜æ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–åˆ†æçš„æ•ˆç‡ã€‚

# å…­ã€æŒç»­æ›´æ–°

## å¦‚ä½•ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ç³»åˆ—

- å¦‚ä½•ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ï¼šæå‡å¯è§‚æµ‹æ€§ï¼ˆå½“å‰ï¼‰
- å¦‚ä½•ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ï¼šæå‡æœåŠ¡æ€§èƒ½ï¼ˆé¢„å‘Šï¼‰
- å¦‚ä½•ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ï¼šæå‡å¯é æ€§ï¼ˆé¢„å‘Šï¼‰
- å¦‚ä½•ä¿éšœæœåŠ¡çš„é«˜å¯ç”¨ï¼šæå‡å‘Šè­¦åº”æ€¥èƒ½åŠ›ï¼ˆé¢„å‘Šï¼‰

> é¢„å‘Šçš„æ–‡ç« å¾…åç»­æŒç»­è¾“å‡ºï¼Œæœ‰å–œæ¬¢çš„æœ‹å‹åŒå‡» ç‚¹èµ æ”¶è— ğŸ‘ + 666ğŸ¤™
>
> ç³»åˆ—æ”¶å½•åœ¨ Github[ã€Šå¤§è¯ WEB å¼€å‘ã€‹](https://github.com/SFLAQiu/web-develop)
